{% extends 'base.html' %}
{% load static %}

{% block title %}ملف العميل - {{ customer.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/customers/customer_profile.css' %}">
<style>
/* Prescription Table Styles */
.prescription-table-wrapper {
    margin: 2rem 0;
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.prescription-table {
    width: 100%;
    border-collapse: collapse;
    text-align: center;
}

.prescription-table thead {
    background: #f8f9fa;
}

.prescription-table th {
    padding: 1rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #666;
    border: 1px solid #e0e0e0;
}

.prescription-table td {
    padding: 1rem;
    border: 1px solid #e0e0e0;
    font-size: 0.875rem;
}

.prescription-table .eye-label {
    font-weight: 600;
    background: #f8f9fa;
    text-align: left;
    padding-right: 1.5rem;
}

.prescription-table .exam-value {
    color: #1a1a1a;
    font-weight: 500;
}

.prescription-table .pd-label {
    text-align: left;
    padding: 1rem 1.5rem;
    background: #fff3e6;
    font-size: 0.875rem;
}

.prescription-table .pd-label strong {
    color: #FF9500;
}

/* Modal Table Styles */
.exam-form-table {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
}

.exam-form-table th,
.exam-form-table td {
    padding: 1rem;
    border: 1px solid #e0e0e0;
    text-align: center;
}

.exam-form-table thead {
    background: #f8f9fa;
}

.exam-form-table th {
    font-size: 0.875rem;
    font-weight: 600;
    color: #666;
}

.exam-form-table .eye-row-label {
    font-weight: 600;
    background: #f8f9fa;
    text-align: left;
    padding-right: 1.5rem;
}

.exam-form-table input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    text-align: center;
    font-size: 0.875rem;
}

.exam-form-table input:focus {
    outline: none;
    border-color: #4A9EAD;
    box-shadow: 0 0 0 2px rgba(74, 158, 173, 0.1);
}

.ipd-row {
    background: #fff3e6;
}

.ipd-row td {
    text-align: left;
    padding: 1rem 1.5rem;
}

.ipd-row label {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #FF9500;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.ipd-row input {
    max-width: 200px;
}

/* Responsive */
@media (max-width: 768px) {
    .prescription-table-wrapper,
    .exam-form-table {
        overflow-x: auto;
    }
    
    .prescription-table,
    .exam-form-table {
        min-width: 600px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="profile-page">
    <!-- Back Button -->
    <button class="btn-back" onclick="window.location.href='{% url 'customers:list' %}'">
        <i class="fas fa-arrow-right"></i>
        <span>العودة إلى قائمة العملاء</span>
    </button>

    <!-- Customer Info Card -->
    <div class="info-card">
        <div class="customer-header">
            <div class="customer-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="customer-details">
                <h1>{{ customer.name }}</h1>
                <div class="customer-badges">
                    <span class="badge badge-gender">{{ customer.gender }}</span>
                    {% if customer.age %}
                    <span class="badge badge-age">{{ customer.age }} سنة</span>
                    {% endif %}
                    <span class="badge badge-id">{{ customer.customer_id }}</span>
                </div>
            </div>
        </div>

        <div class="contact-grid">
            <div class="contact-item">
                <i class="fas fa-phone"></i>
                <div>
                    <div class="contact-label">رقم الجوال</div>
                    <div class="contact-value">{{ customer.phone }}</div>
                </div>
            </div>

            {% if customer.email %}
            <div class="contact-item">
                <i class="fas fa-envelope"></i>
                <div>
                    <div class="contact-label">البريد الإلكتروني</div>
                    <div class="contact-value">{{ customer.email }}</div>
                </div>
            </div>
            {% endif %}

            {% if customer.address %}
            <div class="contact-item">
                <i class="fas fa-map-marker-alt"></i>
                <div>
                    <div class="contact-label">العنوان</div>
                    <div class="contact-value">{{ customer.address }}</div>
                </div>
            </div>
            {% endif %}

            <div class="contact-item">
                <i class="fas fa-calendar"></i>
                <div>
                    <div class="contact-label">تاريخ التسجيل</div>
                    <div class="contact-value">{{ customer.join_date }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Eye Exam Section -->
    <div class="section-card">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-glasses"></i>
                <h2>الفحص الطبي للنظر - Glasses Prescription</h2>
            </div>
            {% if latest_exam %}
            <button class="btn-edit-exam" onclick="showEditExamModal()">
                <i class="fas fa-edit"></i>
                <span>تعديل الفحص</span>
            </button>
            {% endif %}
        </div>

        {% if latest_exam %}
        <!-- Prescription Table -->
        <div class="prescription-table-wrapper">
            <table class="prescription-table">
                <thead>
                    <tr>
                        <th style="width: 100px;"></th>
                        <th>Sphere</th>
                        <th>Cylinder</th>
                        <th>Axis</th>
                        <th>Distance acuity</th>
                        <th>Near acuity</th>
                        <th>Reading addition</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="eye-label">Right</td>
                        <td class="exam-value">{{ latest_exam.right_sphere|default:"-" }}</td>
                        <td class="exam-value">{{ latest_exam.right_cylinder|default:"-" }}</td>
                        <td class="exam-value">{{ latest_exam.right_axis|default:"-" }}°</td>
                        <td class="exam-value">-</td>
                        <td class="exam-value">-</td>
                        <td class="exam-value">{{ latest_exam.right_add|default:"-" }}</td>
                    </tr>
                    <tr>
                        <td class="eye-label">Left</td>
                        <td class="exam-value">{{ latest_exam.left_sphere|default:"-" }}</td>
                        <td class="exam-value">{{ latest_exam.left_cylinder|default:"-" }}</td>
                        <td class="exam-value">{{ latest_exam.left_axis|default:"-" }}°</td>
                        <td class="exam-value">-</td>
                        <td class="exam-value">-</td>
                        <td class="exam-value">{{ latest_exam.left_add|default:"-" }}</td>
                    </tr>
                    <tr>
                        <td class="pd-label" colspan="7">
                            <strong>IPD:</strong> {{ latest_exam.right_pd|default:"-" }} mm
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        {% if latest_exam.notes %}
        <div class="exam-notes">
            <i class="fas fa-file-medical"></i>
            <div>
                <div class="notes-label">ملاحظات الفحص</div>
                <p>{{ latest_exam.notes }}</p>
            </div>
        </div>
        {% endif %}
        
        <div class="exam-date">
            <i class="fas fa-calendar-check"></i>
            <span>تاريخ الفحص: {{ latest_exam.exam_date }}</span>
        </div>
        {% else %}
        <div class="no-exam">
            <div class="no-exam-icon">
                <i class="fas fa-eye-slash"></i>
            </div>
            <p>لا يوجد فحص طبي للنظر</p>
            <button class="btn-add-exam" onclick="showAddExamModal()">
                <i class="fas fa-plus"></i>
                إضافة فحص نظر
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Invoices Section -->
    <div class="section-card">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-file-invoice"></i>
                <h2>الفواتير والإحصائيات</h2>
            </div>
        </div>

        <!-- Invoice Stats -->
        <div class="invoice-stats">
            <div class="stat-item stat-purple">
                <div class="stat-label">إجمالي الفواتير</div>
                <div class="stat-value">{{ invoice_stats.total|floatformat:0 }} ريال</div>
            </div>
            <div class="stat-item stat-green">
                <div class="stat-label">المدفوع</div>
                <div class="stat-value">{{ invoice_stats.paid|floatformat:0 }} ريال</div>
            </div>
            <div class="stat-item stat-orange">
                <div class="stat-label">المعلق</div>
                <div class="stat-value">{{ invoice_stats.pending|floatformat:0 }} ريال</div>
            </div>
            <div class="stat-item stat-blue">
                <div class="stat-label">عدد الفواتير</div>
                <div class="stat-value">{{ invoice_stats.count }}</div>
            </div>
        </div>

        <!-- Invoices Table -->
        {% if invoices %}
        <div class="table-container">
            <table class="invoices-table">
                <thead>
                    <tr>
                        <th>رقم الفاتورة</th>
                        <th>التاريخ</th>
                        <th>العناصر</th>
                        <th>المبلغ</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices %}
                    <tr>
                        <td>{{ invoice.invoice_number }}</td>
                        <td>{{ invoice.date }}</td>
                        <td>-</td>
                        <td class="amount">{{ invoice.total_amount|floatformat:0 }} ريال</td>
                        <td>
                            <span class="status status-{{ invoice.status }}">
                                {% if invoice.status == 'paid' %}مدفوع{% elif invoice.status == 'pending' %}معلق{% else %}ملغي{% endif %}
                            </span>
                        </td>
                        <td>
                            <button class="btn-view-invoice">عرض التفاصيل</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="no-data">
            <i class="fas fa-inbox"></i>
            <p>لا توجد فواتير</p>
        </div>
        {% endif %}
    </div>

    <!-- Notifications Section -->
    <div class="section-card">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-bell"></i>
                <h2>الإشعارات والتواصل</h2>
            </div>
        </div>

        <div class="notifications-grid">
            <!-- Notification Settings -->
            <div class="notification-settings">
                <h3>خيارات الإشعارات</h3>
                <form method="POST" action="{% url 'customers:notifications_update' customer.pk %}">
                    {% csrf_token %}
                    <div class="setting-item">
                        <input type="checkbox" id="whatsapp" name="whatsapp" 
                               {% if customer.notify_whatsapp %}checked{% endif %}>
                        <label for="whatsapp">
                            <i class="fab fa-whatsapp"></i>
                            إرسال رسائل واتساب للعميل
                        </label>
                    </div>
                    <div class="setting-item">
                        <input type="checkbox" id="sms" name="sms" 
                               {% if customer.notify_sms %}checked{% endif %}>
                        <label for="sms">
                            <i class="fas fa-sms"></i>
                            إرسال رسائل SMS
                        </label>
                    </div>
                    <div class="setting-item">
                        <input type="checkbox" id="email" name="email" 
                               {% if customer.notify_email %}checked{% endif %}>
                        <label for="email">
                            <i class="fas fa-envelope"></i>
                            إرسال بريد إلكتروني
                        </label>
                    </div>
                    <button type="submit" class="btn-save">
                        <i class="fas fa-save"></i>
                        حفظ الإعدادات
                    </button>
                </form>
            </div>

            <!-- Notification History -->
            <div class="notification-history">
                <h3>سجل الإشعارات</h3>
                <div class="notifications-list">
                    {% for notification in notifications %}
                    <div class="notification-item">
                        <i class="fas fa-paper-plane notification-icon-{{ notification.get_type_color }}"></i>
                        <div class="notification-content">
                            <div class="notification-title">{{ notification.get_message_type_display }}</div>
                            <div class="notification-meta">
                                تم الإرسال عبر {{ notification.get_notification_type_display }} - 
                                {{ notification.sent_at|date:"Y-m-d H:i" }}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="no-notifications">
                        <i class="fas fa-bell-slash"></i>
                        <p>لا توجد إشعارات</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Eye Exam Modal -->
<div id="examModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="examModalTitle">{% if latest_exam %}تعديل الفحص الطبي للنظر{% else %}إضافة فحص نظر جديد{% endif %}</h2>
            <button class="btn-close" onclick="closeExamModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form method="POST" action="{% if latest_exam %}{% url 'customers:eye_exam_edit' latest_exam.pk %}{% else %}{% url 'customers:eye_exam_add' customer.pk %}{% endif %}">
            {% csrf_token %}
            <div class="modal-body">
                <h3 style="margin-bottom: 1rem;">Glasses Prescription</h3>
                
                <!-- Exam Table -->
                <table class="exam-form-table">
                    <thead>
                        <tr>
                            <th style="width: 100px;"></th>
                            <th>Sphere</th>
                            <th>Cylinder</th>
                            <th>Axis</th>
                            <th>Distance acuity</th>
                            <th>Near acuity</th>
                            <th>Reading addition</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="eye-row-label">Right</td>
                            <td>
                                <input type="text" 
                                       name="right_sphere" 
                                       value="{{ latest_exam.right_sphere|default:'' }}" 
                                       placeholder="+1.25"
                                       autocomplete="off">
                            </td>
                            <td>
                                <input type="text" 
                                       name="right_cylinder" 
                                       value="{{ latest_exam.right_cylinder|default:'' }}" 
                                       placeholder="0.50"
                                       autocomplete="off">
                            </td>
                            <td>
                                <input type="text" 
                                       name="right_axis" 
                                       value="{{ latest_exam.right_axis|default:'' }}" 
                                       placeholder="5°"
                                       autocomplete="off">
                            </td>
                            <td>
                                <input type="text" 
                                       name="right_distance" 
                                       value="" 
                                       placeholder="20/20"
                                       autocomplete="off">
                            </td>
                            <td>
                                <input type="text" 
                                       name="right_near" 
                                       value="" 
                                       placeholder="20/20"
                                       autocomplete="off">
                            </td>
                            <td>
                                <input type="text" 
                                       name="right_add" 
                                       value="{{ latest_exam.right_add|default:'' }}" 
                                       placeholder="+2.00"
                                       autocomplete="off">
                            </td>
                        </tr>
                        <tr>
                            <td class="eye-row-label">Left</td>
                            <td>
                                <input type="text" 
                                       name="left_sphere" 
                                       value="{{ latest_exam.left_sphere|default:'' }}" 
                                       placeholder="+1.50"
                                       autocomplete="off">
                            </td>
                            <td>
                                <input type="text" 
                                       name="left_cylinder" 
                                       value="{{ latest_exam.left_cylinder|default:'' }}" 
                                       placeholder="0.50"
                                       autocomplete="off">
                            </td>
                            <td>
                                <input type="text" 
                                       name="left_axis" 
                                       value="{{ latest_exam.left_axis|default:'' }}" 
                                       placeholder="165°"
                                       autocomplete="off">
                            </td>
                            <td>
                                <input type="text" 
                                       name="left_distance" 
                                       value="" 
                                       placeholder="20/20"
                                       autocomplete="off">
                            </td>
                            <td>
                                <input type="text" 
                                       name="left_near" 
                                       value="" 
                                       placeholder="20/20"
                                       autocomplete="off">
                            </td>
                            <td>
                                <input type="text" 
                                       name="left_add" 
                                       value="{{ latest_exam.left_add|default:'' }}" 
                                       placeholder="+2.00"
                                       autocomplete="off">
                            </td>
                        </tr>
                        <tr class="ipd-row">
                            <td colspan="7">
                                <label for="pd_value">
                                    <i class="fas fa-ruler-horizontal"></i>
                                    IPD (المسافة البؤرية)
                                </label>
                                <input type="text" 
                                       name="pd_value" 
                                       id="pd_value"
                                       value="{{ latest_exam.right_pd|default:'' }}" 
                                       placeholder="58 mm"
                                       autocomplete="off">
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Notes -->
                <div class="form-group" style="margin-top: 2rem;">
                    <label for="notes">
                        <i class="fas fa-sticky-note"></i>
                        ملاحظات الفحص
                    </label>
                    <textarea name="notes" 
                              id="notes"
                              rows="4" 
                              placeholder="أضف أي ملاحظات إضافية عن الفحص..."
                              autocomplete="off"
                              style="width: 100%; padding: 0.75rem; border: 1px solid #e0e0e0; border-radius: 8px;">{{ latest_exam.notes|default:'' }}</textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button type="submit" class="btn-submit">
                    <i class="fas fa-save"></i>
                    <span>حفظ الفحص</span>
                </button>
                <button type="button" class="btn-cancel" onclick="closeExamModal()">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/customers/customer_profile.js' %}"></script>
{% endblock %}