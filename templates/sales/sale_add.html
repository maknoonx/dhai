{% extends 'base.html' %}
{% load static %}

{% block title %}فاتورة جديدة{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/sales/sales.css' %}">
<link rel="stylesheet" href="{% static 'css/sales/sale_add_extra.css' %}">
<style>
    /* Eye Exam Display Styles */
    .eye-exam-display {
        background: linear-gradient(135deg, #f5f7ff 0%, #e8ecff 100%);
        border: 2px solid #667eea;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .exam-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #667eea;
    }
    
    .exam-header h4 {
        margin: 0;
        color: #667eea;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .exam-date-badge {
        background: rgba(102, 126, 234, 0.2);
        color: #667eea;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .exam-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .exam-eye-card {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }
    
    .exam-eye-title {
        color: #667eea;
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e8ecff;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .exam-values {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }
    
    .exam-value-item {
        display: flex;
        justify-content: space-between;
        padding: 0.4rem 0.6rem;
        background: #f8f9ff;
        border-radius: 6px;
    }
    
    .exam-value-item .label {
        color: #7f8c8d;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .exam-value-item .value {
        color: #2c3e50;
        font-weight: 700;
        font-size: 0.9rem;
    }
    
    .exam-pd-row {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
        padding: 1rem;
        background: white;
        border-radius: 10px;
    }
    
    .pd-item {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: #f8f9ff;
        border-radius: 8px;
    }
    
    .pd-item .label {
        color: #667eea;
        font-weight: 700;
        font-size: 0.95rem;
    }
    
    .pd-item .value {
        color: #2c3e50;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .exam-notes {
        background: #fffbea;
        border: 1px solid #ffd700;
        border-radius: 10px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .notes-label {
        color: #856404;
        font-weight: 700;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .notes-text {
        color: #666;
        line-height: 1.6;
        font-size: 0.95rem;
    }
    
    .no-exam-message {
        background: #fff3cd;
        border: 1px dashed #ffc107;
        border-radius: 10px;
        padding: 1rem;
        margin-top: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #856404;
        font-weight: 600;
    }
    
    .no-exam-message i {
        font-size: 1.5rem;
    }
    
    @media (max-width: 768px) {
        .exam-grid {
            grid-template-columns: 1fr;
        }
        
        .exam-values {
            grid-template-columns: 1fr;
        }
        
        .exam-pd-row {
            flex-direction: column;
        }
    }
    </style>
{% endblock %}

{% block content %}
<div class="sale-add-page">
    <div class="page-header">
        <div class="header-content">
            <h1>
                <i class="fas fa-plus-circle"></i>
                فاتورة جديدة
            </h1>
        </div>
        <div class="header-actions">
            <a href="{% url 'sales:list' %}" class="btn btn-outline">
                <i class="fas fa-arrow-right"></i>
                عودة
            </a>
        </div>
    </div>

    <form id="saleForm" method="POST" class="sale-form">
        {% csrf_token %}

        <!-- Customer Selection -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="fas fa-user"></i>
                معلومات العميل
            </h3>
            
            <div id="selectedCustomerDisplay" class="selected-customer-box" style="display: none;">
                <div class="customer-card">
                    <div class="customer-card-header">
                        <div class="customer-info">
                            <h4 id="displayCustomerName"></h4>
                            <p id="displayCustomerDetails"></p>
                        </div>
                        <button type="button" class="btn-remove-customer" onclick="removeCustomer()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            
                <!-- Eye Exam Display Section -->
                <div id="eyeExamDisplay" class="eye-exam-display" style="display: none;">
                    <div class="exam-header">
                        <h4>
                            <i class="fas fa-eye"></i>
                            آخر فحص نظر للعميل
                        </h4>
                        <span id="examDate" class="exam-date-badge"></span>
                    </div>
            
                    <div class="exam-grid">
                        <!-- Right Eye -->
                        <div class="exam-eye-card">
                            <div class="exam-eye-title">
                                <i class="fas fa-eye"></i>
                                العين اليمنى
                            </div>
                            <div class="exam-values">
                                <div class="exam-value-item">
                                    <span class="label">SPH:</span>
                                    <span id="rightSphere" class="value">-</span>
                                </div>
                                <div class="exam-value-item">
                                    <span class="label">CYL:</span>
                                    <span id="rightCylinder" class="value">-</span>
                                </div>
                                <div class="exam-value-item">
                                    <span class="label">AXIS:</span>
                                    <span id="rightAxis" class="value">-</span>
                                </div>
                                <div class="exam-value-item">
                                    <span class="label">ADD:</span>
                                    <span id="rightAdd" class="value">-</span>
                                </div>
                            </div>
                        </div>
            
                        <!-- Left Eye -->
                        <div class="exam-eye-card">
                            <div class="exam-eye-title">
                                <i class="fas fa-eye"></i>
                                العين اليسرى
                            </div>
                            <div class="exam-values">
                                <div class="exam-value-item">
                                    <span class="label">SPH:</span>
                                    <span id="leftSphere" class="value">-</span>
                                </div>
                                <div class="exam-value-item">
                                    <span class="label">CYL:</span>
                                    <span id="leftCylinder" class="value">-</span>
                                </div>
                                <div class="exam-value-item">
                                    <span class="label">AXIS:</span>
                                    <span id="leftAxis" class="value">-</span>
                                </div>
                                <div class="exam-value-item">
                                    <span class="label">ADD:</span>
                                    <span id="leftAdd" class="value">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
            
                    <!-- PD Values -->
                    <div class="exam-pd-row">
                        <div class="pd-item">
                            <span class="label">PD يمين:</span>
                            <span id="rightPD" class="value">-</span>
                        </div>
                        <div class="pd-item">
                            <span class="label">PD يسار:</span>
                            <span id="leftPD" class="value">-</span>
                        </div>
                    </div>
            
                    <!-- Exam Notes -->
                    <div id="examNotesContainer" class="exam-notes" style="display: none;">
                        <div class="notes-label">
                            <i class="fas fa-sticky-note"></i>
                            ملاحظات الفحص:
                        </div>
                        <div id="examNotes" class="notes-text"></div>
                    </div>
                </div>
            
                <!-- No Exam Message -->
                <div id="noExamMessage" class="no-exam-message" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    <span>لا يوجد فحص نظر مسجل لهذا العميل</span>
                </div>
            </div>

            <div id="searchCustomerBtn" class="form-group">
                <button type="button" class="btn btn-select-customer" onclick="showCustomerSearchModal()">
                    <i class="fas fa-search"></i>
                    اختر العميل
                </button>
            </div>

            <input type="hidden" id="customer_id" name="customer_id" required>
        </div>

        <!-- Products & Services Section -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="fas fa-shopping-cart"></i>
                المنتجات والخدمات
            </h3>
            
            <div class="product-search-section">
                <button type="button" class="btn btn-add-product" onclick="showProductSearchModal()">
                    <i class="fas fa-box"></i>
                    إضافة منتج
                </button>
                <button type="button" class="btn btn-add-product" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="showServiceSearchModal()">
                    <i class="fas fa-concierge-bell"></i>
                    إضافة خدمة
                </button>
            </div>

            <div class="selected-products" id="selectedProducts">
                <table class="products-table">
                    <thead>
                        <tr>
                            <th style="width: 40%">العنصر</th>
                            <th style="width: 20%">السعر</th>
                            <th style="width: 15%">الكمية</th>
                            <th style="width: 20%">الإجمالي</th>
                            <th style="width: 5%"></th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem; color: #7f8c8d;">
                                لم يتم إضافة منتجات أو خدمات
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Order Details -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="fas fa-info-circle"></i>
                تفاصيل الطلب
            </h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="delivery_date">تاريخ التسليم المتوقع</label>
                    <input type="date" id="delivery_date" name="delivery_date">
                </div>

                <div class="form-group">
                    <label for="laboratory_id">المعمل (اختياري)</label>
                    <select id="laboratory_id" name="laboratory_id">
                        <option value="">-- لا يوجد --</option>
                        {% for lab in laboratories %}
                        <option value="{{ lab.id }}">{{ lab.laboratory_code }} - {{ lab.company_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group full-width">
                    <label for="prescription_notes">ملاحظات القياس</label>
                    <textarea id="prescription_notes" 
                              name="prescription_notes" 
                              rows="2"
                              placeholder="ملاحظات خاصة بالقياس..."></textarea>
                </div>

                <div class="form-group full-width">
                    <label for="notes">ملاحظات عامة</label>
                    <textarea id="notes" 
                              name="notes" 
                              rows="2"
                              placeholder="أي ملاحظات إضافية..."></textarea>
                </div>
            </div>
        </div>

        <!-- Payment Section -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="fas fa-credit-card"></i>
                الدفع
            </h3>

            <div class="amount-summary">
                <div class="amount-row">
                    <span>المجموع الفرعي:</span>
                    <span id="subtotalDisplay">0.00 ر.س</span>
                </div>
                <div class="amount-row">
                    <span>الخصم:</span>
                    <span>
                        <input type="number" 
                               id="discount" 
                               name="discount" 
                               value="0" 
                               min="0" 
                               step="0.01"
                               onchange="calculateTotal()"> ر.س
                    </span>
                </div>
                <div class="amount-row">
                    <span>الضريبة (15%):</span>
                    <span id="taxDisplay">0.00 ر.س</span>
                </div>
                <div class="amount-row total">
                    <span>الإجمالي:</span>
                    <span id="totalDisplay">0.00 ر.س</span>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="payment_method">طريقة الدفع</label>
                    <select id="payment_method" name="payment_method">
                        {% for method in payment_methods %}
                        <option value="{{ method.0 }}">{{ method.1 }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="paid_amount">المبلغ المدفوع الآن</label>
                    <input type="number" 
                           id="paid_amount" 
                           name="paid_amount" 
                           value="0" 
                           min="0" 
                           step="0.01"
                           placeholder="0.00">
                </div>
            </div>
        </div>

        <input type="hidden" id="products" name="products" value="[]">
        <input type="hidden" id="services" name="services" value="[]">

        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-large">
                <i class="fas fa-save"></i>
                حفظ الفاتورة
            </button>
            <a href="{% url 'sales:list' %}" class="btn btn-cancel btn-large">
                إلغاء
            </a>
        </div>
    </form>
</div>

<!-- Customer Search Modal -->
<div id="customerSearchModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>اختيار العميل</h2>
            <button class="btn-close" onclick="closeCustomerSearchModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="search-box-modal">
                <i class="fas fa-search"></i>
                <input type="text" 
                       id="customerSearchInput" 
                       placeholder="ابحث بالاسم أو رقم الجوال..."
                       onkeyup="searchCustomers()">
            </div>

            <div class="search-results-modal" id="customerSearchResults">
                {% for customer in customers %}
                <div class="customer-result-item" 
                     data-id="{{ customer.id }}"
                     data-customer-id="{{ customer.customer_id }}"
                     data-name="{{ customer.name }}"
                     data-phone="{{ customer.phone }}"
                     data-email="{{ customer.email|default:'' }}"
                     onclick="selectCustomer(this)">
                    <div class="customer-result-info">
                        <h4>{{ customer.name }}</h4>
                        <p>
                            <span class="customer-id">{{ customer.customer_id }}</span>
                            <span class="customer-phone">{{ customer.phone }}</span>
                            {% if customer.email %}
                            <span class="customer-email">{{ customer.email }}</span>
                            {% endif %}
                        </p>
                    </div>
                    <i class="fas fa-chevron-left"></i>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Product Search Modal -->
<div id="productSearchModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>اختيار المنتج</h2>
            <button class="btn-close" onclick="closeProductSearchModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="search-box-modal">
                <i class="fas fa-search"></i>
                <input type="text" 
                       id="productSearchInput" 
                       placeholder="ابحث بالاسم أو الباركود..."
                       onkeyup="searchProducts()">
            </div>

            <div class="search-results-modal" id="productSearchResults">
                {% for product in products %}
                <div class="product-result-item" 
                     data-id="{{ product.id }}"
                     data-name="{{ product.item_name }}"
                     data-price="{{ product.selling_price }}"
                     data-quantity="{{ product.quantity }}"
                     data-barcode="{{ product.barcode }}"
                     onclick="selectProduct(this)">
                    <div class="product-result-info">
                        <h4>{{ product.item_name }}</h4>
                        <p>
                            <span class="product-barcode">{{ product.barcode }}</span>
                            <span class="product-price">{{ product.selling_price }} ر.س</span>
                            <span class="product-stock {% if product.quantity <= 0 %}out-of-stock{% elif product.is_low_stock %}low-stock{% endif %}">
                                متوفر: {{ product.quantity }}
                            </span>
                        </p>
                    </div>
                    <i class="fas fa-plus-circle"></i>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Service Search Modal -->
<div id="serviceSearchModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>اختيار الخدمة</h2>
            <button class="btn-close" onclick="closeServiceSearchModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="search-box-modal">
                <i class="fas fa-search"></i>
                <input type="text" 
                       id="serviceSearchInput" 
                       placeholder="ابحث عن الخدمة..."
                       onkeyup="searchServices()">
            </div>

            <div class="search-results-modal" id="serviceSearchResults">
                {% for service in services %}
                <div class="service-result-item" 
                     data-id="{{ service.id }}"
                     data-code="{{ service.service_code }}"
                     data-name="{{ service.service_name }}"
                     data-price="{{ service.price }}"
                     onclick="selectService(this)">
                    <div class="product-result-info">
                        <h4>{{ service.service_name }}</h4>
                        <p>
                            <span class="product-barcode">{{ service.service_code }}</span>
                            <span class="product-price">{{ service.price }} ر.س</span>
                        </p>
                    </div>
                    <i class="fas fa-plus-circle"></i>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/sales/sale_add.js' %}"></script>
{% endblock %}